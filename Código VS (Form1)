using System;
using System.Net.Http;
using System.Net.Http.Json;
using System.Windows.Forms;
using Newtonsoft.Json;
using System.Collections.Generic;

namespace InventarioPedidosWinForms
{
    public partial class Form1 : Form
    {
        private readonly HttpClient _httpClient;

        public Form1()
        {
            InitializeComponent();
            _httpClient = new HttpClient
            {
                BaseAddress = new Uri("https://localhost:7117/") // Asegúrate de que la URL es correcta
            };
        }

        private async void Form1_Load(object sender, EventArgs e)
        {
            await CargarCategorias();
        }

        private async Task CargarCategorias()
        {
            try
            {
                var categorias = await _httpClient.GetFromJsonAsync<List<Categoria>>("api/categorias");

                // Actualizar ListBox
                listBoxCategorias.DataSource = categorias;
                listBoxCategorias.DisplayMember = "NombreCategoria";
                listBoxCategorias.ValueMember = "IdCategoria";

                // Actualizar ComboBox
                comboBoxCategorias.DataSource = new List<Categoria>(categorias);
                comboBoxCategorias.DisplayMember = "NombreCategoria";
                comboBoxCategorias.ValueMember = "IdCategoria";
            }
            catch (Exception ex)
            {
                MessageBox.Show($"Error al cargar categorías: {ex.Message}");
            }
        }

        private async void btnAgregar_Click(object sender, EventArgs e)
        {
            if (string.IsNullOrEmpty(txtNombreCategoria.Text))
            {
                MessageBox.Show("Por favor ingresa un nombre para la categoría.");
                return;
            }

            var categoria = new Categoria
            {
                NombreCategoria = txtNombreCategoria.Text
            };

            var response = await _httpClient.PostAsJsonAsync("api/categorias", categoria);

            if (response.IsSuccessStatusCode)
            {
                MessageBox.Show("Categoría agregada correctamente.");
                await CargarCategorias();
            }
            else
            {
                MessageBox.Show("Error al agregar la categoría.");
            }
        }

        private async void btnModificar_Click(object sender, EventArgs e)
        {
            if (!int.TryParse(txtIdCategoria.Text, out int id))
            {
                MessageBox.Show("Por favor ingresa un ID válido.");
                return;
            }

            if (string.IsNullOrEmpty(txtNombreCategoria.Text))
            {
                MessageBox.Show("Por favor ingresa un nombre para la categoría.");
                return;
            }

            var categoria = new Categoria
            {
                IdCategoria = id,
                NombreCategoria = txtNombreCategoria.Text
            };

            var response = await _httpClient.PutAsJsonAsync($"api/categorias/{id}", categoria);

            if (response.IsSuccessStatusCode)
            {
                MessageBox.Show("Categoría modificada correctamente.");
                await CargarCategorias();
            }
            else
            {
                MessageBox.Show("Error al modificar la categoría.");
            }
        }

        private async void btnEliminar_Click(object sender, EventArgs e)
        {
            if (!int.TryParse(txtIdCategoria.Text, out int id))
            {
                MessageBox.Show("Por favor ingresa un ID válido.");
                return;
            }

            var response = await _httpClient.DeleteAsync($"api/categorias/{id}");

            if (response.IsSuccessStatusCode)
            {
                MessageBox.Show("Categoría eliminada correctamente.");
                await CargarCategorias();
            }
            else
            {
                MessageBox.Show("Error al eliminar la categoría.");
            }
        }

        private void listBoxCategorias_SelectedIndexChanged(object sender, EventArgs e)
        {
            if (listBoxCategorias.SelectedItem is Categoria categoriaSeleccionada)
            {
                txtIdCategoria.Text = categoriaSeleccionada.IdCategoria.ToString();
                txtNombreCategoria.Text = categoriaSeleccionada.NombreCategoria;
            }
        }

        public class Categoria
        {
            public int IdCategoria { get; set; }
            public string NombreCategoria { get; set; }
        }
    }
}
